name: Generate Application Scaffold
run-name: Generate App - [${{ inputs.correlation_id }}]

on:
    workflow_dispatch:
        inputs:
            app_name:
                description: "Name of the application to create"
                required: true
                type: string
            correlation_id:
                description: "The unique correlation ID"
                type: string
                required: true

jobs:
    generate-scaffold:
        name: Generate App Structure
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GH_PAT }}

            - name: Create app directory
              run: |
                  APP_DIR="apps/${{ inputs.app_name }}"
                  mkdir -p "$APP_DIR"
                  echo "Created directory: $APP_DIR"

            - name: Generate app.py
              run: |
                  cat > apps/${{ inputs.app_name }}/app.py <<'EOF'
                  from flask import Flask, jsonify, request
                  import os
                  import psycopg2
                  from psycopg2.extras import RealDictCursor
                  from datetime import datetime

                  app = Flask(__name__)

                  # Database configuration from environment variables
                  DB_CONFIG = {
                      'host': os.getenv('DB_HOST', 'localhost'),
                      'port': os.getenv('DB_PORT', '5432'),
                      'database': os.getenv('DB_NAME', 'appdb'),
                      'user': os.getenv('DB_USER', 'appuser'),
                      'password': os.getenv('DB_PASSWORD', 'changeme')
                  }

                  def get_db_connection():
                      """Create a database connection."""
                      return psycopg2.connect(**DB_CONFIG)

                  def init_db():
                      """Initialize the database schema."""
                      try:
                          conn = get_db_connection()
                          cur = conn.cursor()
                          cur.execute('''
                              CREATE TABLE IF NOT EXISTS visits (
                                  id SERIAL PRIMARY KEY,
                                  timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                                  ip_address VARCHAR(50)
                              )
                          ''')
                          conn.commit()
                          cur.close()
                          conn.close()
                          print("Database initialized successfully")
                      except Exception as e:
                          print(f"Error initializing database: {e}")

                  # Initialize database on startup
                  init_db()

                  @app.route('/')
                  def home():
                      """Home endpoint with visit tracking."""
                      try:
                          conn = get_db_connection()
                          cur = conn.cursor()

                          # Record visit
                          ip_address = request.remote_addr
                          cur.execute('INSERT INTO visits (ip_address) VALUES (%s)', (ip_address,))
                          conn.commit()

                          # Get total visits
                          cur.execute('SELECT COUNT(*) FROM visits')
                          visit_count = cur.fetchone()[0]

                          cur.close()
                          conn.close()

                          return jsonify({
                              'message': 'Welcome to ${{ inputs.app_name }}!',
                              'visits': visit_count,
                              'timestamp': datetime.utcnow().isoformat()
                          })
                      except Exception as e:
                          return jsonify({'error': str(e)}), 500

                  @app.route('/health')
                  def health():
                      """Health check endpoint."""
                      return jsonify({
                          'status': 'healthy',
                          'app': '${{ inputs.app_name }}',
                          'version': '1.0.0'
                      })

                  @app.route('/ready')
                  def ready():
                      """Readiness check endpoint (includes database connectivity)."""
                      try:
                          conn = get_db_connection()
                          cur = conn.cursor()
                          cur.execute('SELECT 1')
                          cur.close()
                          conn.close()
                          return jsonify({
                              'status': 'ready',
                              'database': 'connected'
                          })
                      except Exception as e:
                          return jsonify({
                              'status': 'not ready',
                              'database': 'disconnected',
                              'error': str(e)
                          }), 503

                  @app.route('/api/visits')
                  def get_visits():
                      """Get recent visits."""
                      try:
                          conn = get_db_connection()
                          cur = conn.cursor(cursor_factory=RealDictCursor)
                          cur.execute('SELECT * FROM visits ORDER BY timestamp DESC LIMIT 10')
                          visits = cur.fetchall()
                          cur.close()
                          conn.close()
                          return jsonify({'visits': visits})
                      except Exception as e:
                          return jsonify({'error': str(e)}), 500

                  @app.route('/api/info')
                  def info():
                      """Application information."""
                      return jsonify({
                          'app_name': '${{ inputs.app_name }}',
                          'version': '1.0.0',
                          'environment': os.getenv('ENVIRONMENT', 'dev'),
                          'database_host': DB_CONFIG['host']
                      })

                  if __name__ == '__main__':
                      app.run(host='0.0.0.0', port=8080, debug=False)
                  EOF
                  echo "Generated app.py"

            - name: Generate requirements.txt
              run: |
                  cat > apps/${{ inputs.app_name }}/requirements.txt <<'EOF'
                  Flask==3.0.0
                  psycopg2-binary==2.9.9
                  gunicorn==21.2.0
                  EOF
                  echo "Generated requirements.txt"

            - name: Generate Dockerfile
              run: |
                  cat > apps/${{ inputs.app_name }}/Dockerfile <<'EOF'
                  FROM python:3.11-slim

                  WORKDIR /app

                  # Install dependencies
                  COPY requirements.txt .
                  RUN pip install --no-cache-dir -r requirements.txt

                  # Copy application code
                  COPY app.py .

                  # Create non-root user
                  RUN useradd -m -u 1000 appuser && \
                      chown -R appuser:appuser /app

                  USER appuser

                  EXPOSE 8080

                  # Health check
                  HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
                    CMD python -c "import urllib.request; urllib.request.urlopen('http://localhost:8080/health')" || exit 1

                  # Run with gunicorn for production
                  CMD ["gunicorn", "--bind", "0.0.0.0:8080", "--workers", "2", "--timeout", "60", "app:app"]
                  EOF
                  echo "Generated Dockerfile"

            - name: Generate README
              run: |
                  cat > apps/${{ inputs.app_name }}/README.md <<'EOF'
                  # ${{ inputs.app_name }}

                  Python Flask application with PostgreSQL integration.

                  ## Endpoints

                  - `GET /` - Welcome page with visit counter
                  - `GET /health` - Health check
                  - `GET /ready` - Readiness check (includes database connectivity)
                  - `GET /api/visits` - Get recent visits
                  - `GET /api/info` - Application information

                  ## Environment Variables

                  - `DB_HOST` - Database host (default: localhost)
                  - `DB_PORT` - Database port (default: 5432)
                  - `DB_NAME` - Database name (default: appdb)
                  - `DB_USER` - Database user (default: appuser)
                  - `DB_PASSWORD` - Database password (default: changeme)
                  - `ENVIRONMENT` - Environment name (default: dev)

                  ## Local Development

                  ```bash
                  # Install dependencies
                  pip install -r requirements.txt

                  # Run the application
                  python app.py
                  ```

                  ## Docker Build

                  ```bash
                  # Build image
                  docker build -t ${{ inputs.app_name }}:latest .

                  # Run container
                  docker run -p 8080:8080 \
                    -e DB_HOST=localhost \
                    -e DB_NAME=appdb \
                    -e DB_USER=appuser \
                    -e DB_PASSWORD=changeme \
                    ${{ inputs.app_name }}:latest
                  ```

                  ## Deployment

                  This application is designed to be deployed via Kratix AppStack Promise.

                  Generated by kratix-workloads scaffold workflow.
                  EOF
                  echo "Generated README.md"

            - name: Commit and push changes
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git add apps/${{ inputs.app_name }}
                  git commit -m "Generate scaffold for ${{ inputs.app_name }}"

                  # Pull latest changes and rebase if needed
                  git pull --rebase origin master
                  git push

            - name: Summary
              run: |
                  echo "### ✅ Application Scaffold Generated" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Application:** \`${{ inputs.app_name }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "**Location:** \`apps/${{ inputs.app_name }}/\`" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "#### Generated Files:" >> $GITHUB_STEP_SUMMARY
                  echo "- ✅ app.py" >> $GITHUB_STEP_SUMMARY
                  echo "- ✅ requirements.txt" >> $GITHUB_STEP_SUMMARY
                  echo "- ✅ Dockerfile" >> $GITHUB_STEP_SUMMARY
                  echo "- ✅ README.md" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "#### Next Steps:" >> $GITHUB_STEP_SUMMARY
                  echo "1. Review the generated files" >> $GITHUB_STEP_SUMMARY
                  echo "2. Customize app.py as needed" >> $GITHUB_STEP_SUMMARY
                  echo "3. Run the build workflow to create Docker image" >> $GITHUB_STEP_SUMMARY
